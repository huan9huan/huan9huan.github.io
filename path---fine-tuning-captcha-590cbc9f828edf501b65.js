webpackJsonp([0x8b1c0f202d8d],{399:function(A,a){A.exports={data:{site:{siteMetadata:{title:"huan9huan的博客",author:"huang huan"}},markdownRemark:{id:"/Users/alhuang/work/blog/src/pages/fine-tuning-captcha/index.md absPath of file >>> MarkdownRemark",html:'<p>本文是对 <a href="https://ypw.io/captcha/">https://ypw.io/captcha/</a> 的验证码训练的改造，目的是解决不容易训练成功的å问题。</p>\n<p>方法是使用预先生成少量数据先训练出较好的模型，然后再使用online的captcha做训练，更加容易训练成功。</p>\n<h2>预先生成一部分数据作为稳定的数据集(offline dataset)</h2>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">npy_file_count = 10\ncount_each_npy = 128\nrootdir=&quot;./data/&quot;\n!rm -fr ${rootdir}\nmkdir_p(rootdir)\n\nprint(&quot;start to generate, total count - &quot; + str(npy_file_count * count_each_npy))\nfor t in range(0,npy_file_count):\n   X, y = next(gen(count_each_npy))\n   np.save(rootdir + str(t) + &quot;.npy&quot;, [X, y])</code></pre>\n      </div>\n<h2>编写对offline数据集的产生函数</h2>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">def batch_gen(batch_size = 16):\n  batch_idx = 0\n  while True:\n      [X_all, y_all] = np.load(rootdir + str(batch_idx) + &quot;.npy&quot;)\n      for i in range(count_each_npy/batch_size):\n          yield X_all[(i * batch_size):((i+1) * batch_size)], [y_all[j][(i * batch_size):((i+1) * batch_size)] for j in range(4)]\n      batch_idx += 1\n      batch_idx %= npy_file_count</code></pre>\n      </div>\n<h2>替换之前直接使用online的数据集，使用offline数据集做训练</h2>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">model.fit_generator(batch_gen(), samples_per_epoch=1280, nb_epoch=5, \n                    nb_worker=2, pickle_safe=True, \n                    validation_data=batch_gen(), nb_val_samples=160)\nmodel.save_weights(&quot;captcha-offline.h5&quot;)</code></pre>\n      </div>\n<p>此时，一般会得到较为收敛的结果，我自己跑的是 train loss=0.08, val loss=0.1，但是evaluate的结果很差： 0.03 （使用online的数据集做evaluate）</p>\n<h2>使用oneline的数据集做fine tuning</h2>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text"># train by online\nmodel.fit_generator(gen(), samples_per_epoch=1280, nb_epoch=5, \n                    nb_worker=2, pickle_safe=True, \n                    validation_data=gen(), nb_val_samples=160)\nmodel.save_weights(&quot;captcha-online.h5&quot;)</code></pre>\n      </div>\n<p>注意：优化器使用adadelta，不要使用SGD， learning rate可不调。  </p>\n<p>两次跑的结果对比如下：<br>\n<a\n    class="gatsby-resp-image-link"\n    href="/static/val_loss-9dd6f2fe76cc44b9a3348c0b5363ad5c-a9ea6.jpg"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 60.35805626598465%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHu2I0K/8QAFxAAAwEAAAAAAAAAAAAAAAAAAAEQEf/aAAgBAQABBQI2O//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABkQAAMBAQEAAAAAAAAAAAAAAAABMREQUf/aAAgBAQABPyGQx6KCLeKH/9oADAMBAAIAAwAAABCsz//EABURAQEAAAAAAAAAAAAAAAAAABAh/9oACAEDAQE/EIf/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAcEAEAAgMAAwAAAAAAAAAAAAABABEhMXFRYfD/2gAIAQEAAT8QXOmLzEBWleYlCidigpfZ9v1NHJ//2Q==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"\n        alt="validation loss - offline vs. online"\n        title=""\n        src="/static/val_loss-9dd6f2fe76cc44b9a3348c0b5363ad5c-f8fb9.jpg"\n        srcset="/static/val_loss-9dd6f2fe76cc44b9a3348c0b5363ad5c-e8976.jpg 148w,\n/static/val_loss-9dd6f2fe76cc44b9a3348c0b5363ad5c-63df2.jpg 295w,\n/static/val_loss-9dd6f2fe76cc44b9a3348c0b5363ad5c-f8fb9.jpg 590w,\n/static/val_loss-9dd6f2fe76cc44b9a3348c0b5363ad5c-85e3d.jpg 885w,\n/static/val_loss-9dd6f2fe76cc44b9a3348c0b5363ad5c-d1924.jpg 1180w,\n/static/val_loss-9dd6f2fe76cc44b9a3348c0b5363ad5c-a9ea6.jpg 1564w"\n        sizes="(max-width: 590px) 100vw, 590px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h2>对模型做evaluate</h2>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">from tqdm import tqdm\ndef evaluate(model, batch_num=32):\n    batch_acc = 0\n    generator = gen()\n    for i in tqdm(range(batch_num)):\n        X, y = next(generator)\n        y_pred = model.predict(X)\n        y_pred = np.argmax(y_pred, axis=2).T\n        y_true = np.argmax(y, axis=2).T\n        batch_acc += np.mean(map(np.array_equal, y_true, y_pred))\n    return batch_acc / batch_num\n\nevaluate(model)</code></pre>\n      </div>\n<p>运行的结果：</p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">100%|██████████| 32/32 [00:04&lt;00:00,  7.61it/s]\n0.9365234375</code></pre>\n      </div>\n<h2>原因分析</h2>\n<blockquote>\n<p>验证码的产生很随机，直接train一个model，可能需要耗费很长的时间才能走出。我自己训练下来，十几次才有一次会从loss在14.4突然降低到5.0附近，随机性比较大。<br>\n先用少量数据做pre-train，得到一个overfitting很厉害的model，然后在用online的数据继续train，这样两步法，会让整个训练的时间效率大大提升。  </p>\n</blockquote>\n<p>一个case：\n\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/captcha-sample-acfc0df732829d255f39be8b01b224eb-0a6eb.jpg"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 51.92307692307693%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAe1dgoX/xAAYEAACAwAAAAAAAAAAAAAAAAABERIgMf/aAAgBAQABBQJmQyn/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAaEAACAgMAAAAAAAAAAAAAAAAAAREhEDFR/9oACAEBAAE/IXUih+IFlaP/2gAMAwEAAgADAAAAEOfP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFxEAAwEAAAAAAAAAAAAAAAAAARARUf/aAAgBAgEBPxCHV//EABsQAAMAAgMAAAAAAAAAAAAAAAABETFhIUFR/9oACAEBAAE/EK6tvB7p3uPdnJDydmA//9k=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"\n        alt="captcha sample"\n        title=""\n        src="/static/captcha-sample-acfc0df732829d255f39be8b01b224eb-f8fb9.jpg"\n        srcset="/static/captcha-sample-acfc0df732829d255f39be8b01b224eb-e8976.jpg 148w,\n/static/captcha-sample-acfc0df732829d255f39be8b01b224eb-63df2.jpg 295w,\n/static/captcha-sample-acfc0df732829d255f39be8b01b224eb-f8fb9.jpg 590w,\n/static/captcha-sample-acfc0df732829d255f39be8b01b224eb-0a6eb.jpg 832w"\n        sizes="(max-width: 590px) 100vw, 590px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>很喜欢深度学习的原因之一，是这个东西是可以迭代的，这个现实世界非常契合。</p>',frontmatter:{title:"Fine Tuning Captcha",date:"July 23, 2018"}}},pathContext:{slug:"/fine-tuning-captcha/",previous:{fields:{slug:"/cs-is-big-hummer/"},frontmatter:{title:"CS is a big hummer"}},next:{fields:{slug:"/walk-or-run/"},frontmatter:{title:"是走还是跑，这是一个问题"}}}}}});
//# sourceMappingURL=path---fine-tuning-captcha-590cbc9f828edf501b65.js.map